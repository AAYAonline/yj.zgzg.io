---
layout: default
title: Update Spreadsheet
---
<!--These are JavaScript Libraries-->
<script type="text/javascript" src="https://contrafabulists-toolbox.github.io/master/javascript/cookies.js"></script>
<script type="text/javascript" src="https://contrafabulists-toolbox.github.io/master/javascript/tabletop.js"></script>
<script type="text/javascript" src="https://ggtkx.org/assets/js/github.js"></script>
<h1>Update</h1>
<script type="text/javascript">
// Reset the cookie manually
//Cookies.expire('token');

// URL: https://ggtkx.org/pull-sheet/?key=your_key&worksheet=worksheet_name&token=your_personal_access_token&org=your_org&repo=your_repo&branch=your_branch

const queryString = window.location.search;
const urlParams = new URLSearchParams(queryString);
const key = urlParams.get('key');
const resource = urlParams.get('worksheet');
const org = urlParams.get('org');
const repo_name = urlParams.get('repo');
const branch = urlParams.get('branch');
const dry_run = urlParams.has('dry_run');

let oAuthToken = urlParams.get('token');
if (oAuthToken != '') {
    Cookies.set('token', oAuthToken);
}
// Grab the token from cookie
oAuthToken = Cookies.get('token');

document.addEventListener("DOMContentLoaded", () => {
    Tabletop.init({
        key: key,
        callback: convert,
        wanted: [resource],
        debug: true
    })
})

console.log(resource);

function publish(people) {
  new_people = new Array();
  for (let index in people) {
      let current_person = people[index];
      if (current_person["image"] != "") {
          if (current_person["contact"] != "") {
              current_person["contact"] = [current_person["contact"]]
          }
          new_people.push(current_person)
      }
  }
  json_dump = JSON.stringify(new_people, null, 4);
  document.getElementById('source').value = json_dump;

  if (dry_run != '') {
    console.log('Dry run. Will not commit.');
    return;
  }

  // Grab the token from cookie
  oAuthToken = Cookies.get('token');

  let github = new Github({ token: oAuthToken, auth: "oauth" });
  let repo = github.getRepo(org, repo);

  writepath = '_data/' + resource + '.json';
  const current_time = Date.now()
  repo.write(branch, writepath, json_dump, 'Update comedian info based on Google sheets at ' + current_time, function(err) {});
  console.log("writing 1:" + writepath);
  repo.getTree(branch + '?recursive=true', function(err, tree) {

      tree.forEach(treeValue => {

          path = treeValue['path'];
          sha = treeValue['sha'];

          //console.log(path + ' == ' + writepath);

          if (path == writepath) {
              console.log(json_dump)
              repo.writemanual(branch, writepath, json_dump, 'Update comedian info based on Google sheets at ' + current_time, sha, function(err) {});
              console.log("writing 2:" + writepath);
              //alert("saved " + writepath);
          }
      });
  });
}

function convert(data, tabletop) {
    rows = tabletop.sheets(resource).all();
    people = new Array();

    rows.forEach(row => {
        person = {};
        for (const [key, value] of Object.entries(row)) {
            person[key] = value;
        };
        people.push(person);
        if (people.length == rows.length) {
          publish(people);
        }
    });
}
</script>
<textarea cols="10" rows="5" id="source" style="border: 1px solid #000; width: 100%; height: 350px;"></textarea>